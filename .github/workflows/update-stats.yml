name: Update GitHub Stats

on:
  schedule:
    - cron: "*/5 * * * *" # 00:10 (UTC+7)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch GitHub Stats SVG
        run: |
          mkdir -p assets

          URL="https://github-readme-stats-umber-five-12.vercel.app/api?username=TNTKien&show_icons=true&theme=dracula"

          echo "Fetching: $URL"

          curl -L \
            --retry 5 \
            --retry-delay 2 \
            --max-time 30 \
            -H "User-Agent: github-actions" \
            "$URL" \
            -o assets/github-stats.svg

          echo "---- File preview ----"
          head -n 20 assets/github-stats.svg || true

          echo "---- File size ----"
          ls -lh assets/github-stats.svg

          if ! grep -qi "<svg" assets/github-stats.svg; then
            echo "::error::Downloaded file is not a valid SVG"
            exit 1
          fi

      - name: Commit & Push
        run: |
          git status
          git add assets/github-stats.svg

          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git commit -m "chore: update github stats"
            git push
          fi
